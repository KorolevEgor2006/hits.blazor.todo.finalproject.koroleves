@page "/admin/dashboard"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Identity
@using TheFinalProject.Data.Models
@using TheFinalProject.Data.Interfaces
@inject ICourseService data
@inject NavigationManager navigate
@inject IJSRuntime JS

<PageTitle>Админ панель</PageTitle>

<div class="container-fluid">
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h4 class="mb-0">
                <i class="bi bi-shield-check me-2"></i>Панель администратора
            </h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="card bg-primary text-white mb-3">
                        <div class="card-body">
                            <h1 class="display-4">@totalUsers</h1>
                            <p class="mb-0">Пользователей</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-success text-white mb-3">
                        <div class="card-body">
                            <h1 class="display-4">@totalCourses</h1>
                            <p class="mb-0">Курсов</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-warning text-dark mb-3">
                        <div class="card-body">
                            <h1 class="display-4">@totalEnrollments</h1>
                            <p class="mb-0">Записей на курсы</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="card bg-info text-white mb-3">
                        <div class="card-body">
                            <h1 class="display-4">@activeSessions</h1>
                            <p class="mb-0">Активных сессий</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>Статистика пользователей
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Студенты:</span>
                            <strong>@studentCount</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" role="progressbar"
                                 style="width: @(totalUsers > 0 ? (double)studentCount / totalUsers * 100 : 0)%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Преподаватели:</span>
                            <strong>@instructorCount</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 style="width: @(totalUsers > 0 ? (double)instructorCount / totalUsers * 100 : 0)%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Администраторы:</span>
                            <strong>@adminCount</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" role="progressbar"
                                 style="width: @(totalUsers > 0 ? (double)adminCount / totalUsers * 100 : 0)%"></div>
                        </div>
                    </div>

                    <div class="row text-center mt-4">
                        <div class="col-6">
                            <div class="card border">
                                <div class="card-body py-3">
                                    <div class="display-6">@newUsersToday</div>
                                    <small class="text-muted">Новых сегодня</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card border">
                                <div class="card-body py-3">
                                    <div class="display-6">@activeUsersToday</div>
                                    <small class="text-muted">Активных сегодня</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning me-2"></i>Быстрые действия
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" @onclick="ManageUsers">
                            <i class="bi bi-people-fill me-2"></i>Управление пользователями
                        </button>
                        
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-speedometer2 me-2"></i>Обзор платформы
                    </h5>
                    <small class="text-muted">Обновлено: @DateTime.Now.ToString("HH:mm:ss")</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-graph-up text-primary me-2"></i>Рост пользователей
                                    </h6>
                                    <div class="text-center py-3">
                                        <div class="display-4 text-primary">+@userGrowth%</div>
                                        <small class="text-muted">за последний месяц</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-cash-coin text-success me-2"></i>Доход платформы
                                    </h6>
                                    <div class="text-center py-3">
                                        <div class="display-4 text-success">@platformRevenue.ToString("C")</div>
                                        <small class="text-muted">за последний месяц</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-book text-warning me-2"></i>Средняя завершенность
                                    </h6>
                                    <div class="text-center py-3">
                                        <div class="display-4 text-warning">@averageCompletionRate.ToString("F1")%</div>
                                        <small class="text-muted">по всем курсам</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-star text-info me-2"></i>Средний рейтинг
                                    </h6>
                                    <div class="text-center py-3">
                                        <div class="display-4 text-info">@averageRating.ToString("F1")</div>
                                        <small class="text-muted">по всем курсам</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-activity me-2"></i>Недавняя активность системы
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (recentSystemActivity.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Пользователь</th>
                                        <th>Действие</th>
                                        <th>Время</th>
                                        <th>IP Адрес</th>
                                        <th>Статус</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var activity in recentSystemActivity)
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="flex-shrink-0">
                                                        <i class="bi bi-person-circle me-2"></i>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <div>@activity.UserName</div>
                                                        <small class="text-muted">@activity.UserRole</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge @activity.BadgeClass">
                                                    <i class="bi @activity.Icon me-1"></i>@activity.Action
                                                </span>
                                            </td>
                                            <td>
                                                <small>@activity.Time.ToString("dd.MM.yyyy HH:mm")</small>
                                            </td>
                                            <td>
                                                <code>@activity.IpAddress</code>
                                            </td>
                                            <td>
                                                @if (activity.Status == "Успешно")
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle me-1"></i>@activity.Status
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-x-circle me-1"></i>@activity.Status
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-activity text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">Активность не найдена</p>
                        </div>
                    }
                
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int totalUsers = 0;
    private int totalCourses = 0;
    private int totalEnrollments = 0;
    private int activeSessions = 0;
    private int studentCount = 0;
    private int instructorCount = 0;
    private int adminCount = 0;
    private int newUsersToday = 0;
    private int activeUsersToday = 0;
    private double userGrowth = 0;
    private decimal platformRevenue = 0;
    private double averageCompletionRate = 0;
    private double averageRating = 0;
    private List<SystemActivity> recentSystemActivity = new();
    private int totalActivities = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        await LoadSystemActivity();
    }

    private async Task LoadDashboardData()
    {
        var allUsers = await GetUsersAsync();
        totalUsers = allUsers.Count;
        foreach (var user in allUsers)
        {
            if (user is Administrator)
                adminCount++;
            else if (user is Instructor)
                instructorCount++;
            else if (user is Student)
                studentCount++;
            if (user.RegistrationDate.Date == DateTime.Today)
                newUsersToday++;
        }
        var allCourses = await data.GetAllCoursesAsync();
        totalCourses = allCourses.Count();
        totalEnrollments = allCourses.Sum(c => c.StudentCount);
        averageCompletionRate = allCourses.Any() ? allCourses.Average(c => c.CompletionRate) : 0;
        averageRating = allCourses.Any(c => c.Rating > 0) ? allCourses.Where(c => c.Rating > 0).Average(c => c.Rating) : 0;
        activeSessions = new Random().Next(50, 200);
        userGrowth = new Random().Next(5, 25);
        platformRevenue = allCourses.Sum(c => c.Price * c.StudentCount) * 0.3m;
        activeUsersToday = new Random().Next(100, 500);
    }

    private async Task<List<ApplicationUser>> GetUsersAsync()
    {
        await Task.Delay(100);
        return new List<ApplicationUser>();
    }

    private async Task LoadSystemActivity()
    {
        recentSystemActivity = new List<SystemActivity>
        {
            new() {
                UserName = "Администратор",
                UserRole = "Admin",
                Action = "Вход в систему",
                Time = DateTime.Now.AddMinutes(-5),
                IpAddress = "192.168.1.1",
                Status = "Успешно",
                Icon = "bi-box-arrow-in-right",
                BadgeClass = "bg-primary"
            },
            new() {
                UserName = "Иван Петров",
                UserRole = "Instructor",
                Action = "Создал новый курс",
                Time = DateTime.Now.AddMinutes(-15),
                IpAddress = "192.168.1.2",
                Status = "Успешно",
                Icon = "bi-plus-circle",
                BadgeClass = "bg-success"
            },
            new() {
                UserName = "Анна Сидорова",
                UserRole = "Student",
                Action = "Записалась на курс",
                Time = DateTime.Now.AddMinutes(-30),
                IpAddress = "192.168.1.3",
                Status = "Успешно",
                Icon = "bi-journal-plus",
                BadgeClass = "bg-info"
            },
            new() {
                UserName = "Петр Иванов",
                UserRole = "Instructor",
                Action = "Обновил курс",
                Time = DateTime.Now.AddHours(-1),
                IpAddress = "192.168.1.4",
                Status = "Успешно",
                Icon = "bi-arrow-clockwise",
                BadgeClass = "bg-warning text-dark"
            },
            new() {
                UserName = "Неизвестный пользователь",
                UserRole = "Guest",
                Action = "Попытка входа",
                Time = DateTime.Now.AddHours(-2),
                IpAddress = "10.0.0.1",
                Status = "Неудачно",
                Icon = "bi-shield-exclamation",
                BadgeClass = "bg-danger"
            }
        };

        totalActivities = recentSystemActivity.Count;
    }

    private void ManageUsers() => navigate.NavigateTo("/admin/users");

    private class SystemActivity
    {
        public string UserName { get; set; } = string.Empty;
        public string UserRole { get; set; } = string.Empty;
        public string Action { get; set; } = string.Empty;
        public DateTime Time { get; set; }
        public string IpAddress { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
        public string BadgeClass { get; set; } = string.Empty;
    }
}