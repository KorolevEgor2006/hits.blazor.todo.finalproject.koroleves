@page "/courses/{Id:int}"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using TheFinalProject.Data.Models
@using TheFinalProject.Data.Interfaces
@inject ICourseService data
@inject NavigationManager navigate
@inject AuthenticationStateProvider authProvider
@inject IJSRuntime JS

<PageTitle>@(Course?.Title ?? "Курс")</PageTitle>

@if (Course == null)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>
}
else
{
    <div class="container">
        
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/courses">Курсы</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Course.Title</li>
            </ol>
        </nav>

        <div class="card mb-4">
            <div class="row g-0">
                <div class="col-md-4">
                    @if (!string.IsNullOrEmpty(Course.ImageUrl))
                    {
                        <img src="@Course.ImageUrl" class="img-fluid rounded-start" alt="@Course.Title" style="height: 300px; object-fit: cover;">
                    }
                    else
                    {
                        <div class="bg-secondary d-flex align-items-center justify-content-center h-100">
                            <i class="bi bi-journal-text text-white" style="font-size: 5rem;"></i>
                        </div>
                    }
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h1 class="card-title">@Course.Title</h1>
                                <p class="card-text lead">@Course.ShortDescription</p>
                            </div>
                            <div>
                                @if (Course.Price == 0)
                                {
                                    <span class="badge bg-success fs-6">Бесплатно</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning fs-6">@Course.Price.ToString("C")</span>
                                }
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <p><i class="bi bi-person me-2"></i><strong>Преподаватель:</strong> @Course.Instructor?.FullName</p>
                                <p><i class="bi bi-clock me-2"></i><strong>Длительность:</strong> @Course.ActualDurationHours часов</p>
                                <p><i class="bi bi-bar-chart me-2"></i><strong>Уровень:</strong> @Course.Level</p>
                            </div>
                            <div class="col-md-6">
                                <p><i class="bi bi-people me-2"></i><strong>Студентов:</strong> @Course.StudentCount</p>
                                <p>
                                    <i class="bi bi-star me-2"></i><strong>Рейтинг:</strong>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="bi @(i <= Math.Round(Course.Rating) ? "bi-star-fill text-warning" : "bi-star")"></i>
                                    }
                                    (@Course.Rating.ToString("F1") из 5)
                                </p>
                                <p><i class="bi bi-tag me-2"></i><strong>Категория:</strong> @Course.Category</p>
                            </div>
                        </div>

                        <div class="mt-4">
                            @if (isEnrolled)
                            {
                                <div class="alert alert-success">
                                    <h5><i class="bi bi-check-circle"></i> Вы записаны на этот курс!</h5>
                                    @if (enrollmentProgress > 0)
                                    {
                                        <div class="mt-2">
                                            <div class="d-flex justify-content-between">
                                                <span>Ваш прогресс:</span>
                                                <span>@enrollmentProgress.ToString("F1")%</span>
                                            </div>
                                            <div class="progress mt-1">
                                                <div class="progress-bar bg-success" role="progressbar"
                                                     style="width: @enrollmentProgress%"
                                                     aria-valuenow="@enrollmentProgress"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    }
                                    <button class="btn btn-success mt-3" @onclick="StartLearning">
                                        <i class="bi bi-play-circle"></i> @(enrollmentProgress > 0 ? "Продолжить обучение" : "Начать обучение")
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <h5><i class="bi bi-info-circle"></i> Хотите начать обучение?</h5>
                                    <p>Запишитесь на курс, чтобы получить доступ ко всем урокам и тестам.</p>
                                    <button class="btn btn-primary" @onclick="EnrollInCourse">
                                        <i class="bi bi-plus-circle"></i> Записаться на курс
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4" id="courseTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">
                    <i class="bi bi-file-text me-2"></i>Описание
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="program-tab" data-bs-toggle="tab" data-bs-target="#program" type="button" role="tab">
                    <i class="bi bi-list-ol me-2"></i>Программа курса (@Course.LessonCount)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">
                    <i class="bi bi-star me-2"></i>Отзывы (@Course.ReviewCount)
                </button>
            </li>
        </ul>

        <div class="tab-content" id="courseTabsContent">
            
            <div class="tab-pane fade show active" id="description" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h4>О курсе</h4>
                        <div class="course-description">
                            @MarkupContent(Course.Description)
                        </div>

                        @if (Course.Tags?.Any() == true)
                        {
                            <div class="mt-4">
                                <h5>Теги:</h5>
                                <div>
                                    @foreach (var tag in Course.Tags)
                                    {
                                        <span class="badge bg-secondary me-2 mb-2">@tag</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="program" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h4>Программа курса</h4>
                        @if (Course.Elements?.Any() == true)
                        {
                            <div class="list-group">
                                @{
                                    var lessons = Course.GetLessons().ToList();
                                    var quizzes = Course.GetQuizzes().ToList();
                                    var allElements = lessons.Cast<CourseElement>().Concat(quizzes.Cast<CourseElement>())
                                    .OrderBy(e => e.OrderNumber).ToList();
                                }

                                @foreach (var element in allElements)
                                {
                                    @if (element is Lesson lesson)
                                    {
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="mb-1">
                                                        <i class="bi bi-play-circle text-primary me-2"></i>
                                                        Урок @lesson.OrderNumber: @lesson.Title
                                                    </h5>
                                                    <p class="mb-1 text-muted">@lesson.Description</p>
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock"></i> ~@lesson.GetEstimatedDuration() ч.
                                                        @if (lesson.Quizzes?.Any() == true)
                                                        {
                                                            <i class="bi bi-question-circle ms-3">@lesson.Quizzes.Count тестов</i>
                                                            
                                                            
                                                                                                }
                                                    </small>
                                                </div>
                                                @if (isEnrolled)
                                                {
                                                    <button class="btn btn-outline-primary btn-sm"
                                                            @onclick='() => navigate.NavigateTo($"/lessons/{lesson.Id}")'>
                                                        <i class="bi bi-play"></i> Начать
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    }
                                    else if (element is Quiz quiz)
                                    {
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="mb-1">
                                                        <i class="bi bi-question-circle text-warning me-2"></i>
                                                        Тест: @quiz.Title
                                                    </h5>
                                                    <p class="mb-1 text-muted">@quiz.Description</p>
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock"></i> @quiz.TimeLimitMinutes мин.
                                                        <i class="bi bi-trophy ms-3"></i> @quiz.Points баллов
                                                    </small>
                                                </div>
                                                @if (isEnrolled)
                                                {
                                                    <button class="btn btn-outline-warning btn-sm"
                                                            @onclick='() => navigate.NavigateTo($"/quizzes/{quiz.Id}")'>
                                                        <i class="bi bi-play"></i> Пройти
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-journal text-muted" style="font-size: 4rem;"></i>
                                <p class="mt-3 text-muted">Программа курса еще не добавлена</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="reviews" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h4>Отзывы студентов</h4>

                        @if (Course.ReviewCount > 0)
                        {
                            <div class="row mb-4">
                                <div class="col-md-3 text-center">
                                    <div class="display-4 text-warning">@Course.Rating.ToString("F1")</div>
                                    <div class="star-rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="bi bi-star-fill text-warning"></i>
                                        }
                                    </div>
                                    <small class="text-muted">на основе @Course.ReviewCount отзывов</small>
                                </div>
                            </div>

                            @if (isEnrolled && !hasReviewed)
                            {
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5><i class="bi bi-chat-left-text"></i> Оставить отзыв</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Оценка</label>
                                            <div class="star-rating-input">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="bi @(i <= newReviewRating ? "bi-star-fill text-warning" : "bi-star")"
                                                       style="cursor: pointer; font-size: 1.5rem;"
                                                       @onclick="() => { newReviewRating = i; }"></i>
                                                }
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Комментарий (необязательно)</label>
                                            <textarea class="form-control" rows="3" @bind="newReviewComment"></textarea>
                                        </div>
                                        <button class="btn btn-primary" @onclick="SubmitReview" disabled="@isSubmittingReview">
                                            @if (isSubmittingReview)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2"> Отправка...</span>
                                               
                                                                }
                                            else
                                            {
                                                <i class="bi bi-send me-2">Отправить отзыв</i>
                                                
                                                                }
                                        </button>
                                    </div>
                                </div>
                            }

                            
                        }
                        else
                        {
                            
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Course? Course { get; set; }
    private bool isEnrolled = false;
    private bool hasReviewed = false;
    private double enrollmentProgress = 0;
    private string? userId;
    private Enrollment? enrollment;

    private int newReviewRating = 5;
    private string newReviewComment = string.Empty;
    private bool isSubmittingReview = false;

    protected override async Task OnInitializedAsync()
    {
        Course = await data.GetCourseByIdAsync(Id);

        if (Course == null)
        {
            navigate.NavigateTo("/courses");
            return;
        }

        var authState = await authProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (userId != null)
        {
            isEnrolled = await data.IsUserEnrolledAsync(userId, Id);
            if (isEnrolled)
            {
                enrollment = await data.GetUserEnrollmentAsync(userId, Id);
                enrollmentProgress = enrollment?.ProgressPercentage ?? 0;

                if (Course.Reviews?.Any(r => r.UserId == userId) == true)
                {
                    hasReviewed = true;
                }
            }
        }
    }

    private async Task EnrollInCourse()
    {
        if (userId != null)
        {
            var result = await data.EnrollUserInCourseAsync(userId, Id);
            if (result != null)
            {
                isEnrolled = true;
                enrollment = result;
                enrollmentProgress = 0;
                StateHasChanged();

                await JS.InvokeVoidAsync("showToast", "success", "Вы успешно записались на курс!");
            }
        }
    }

    private void StartLearning()
    {
        if (Course?.Elements?.Any() == true)
        {
            var firstLesson = Course.GetLessons().FirstOrDefault();
            if (firstLesson != null)
            {
                navigate.NavigateTo($"/lessons/{firstLesson.Id}");
            }
            else
            {
                var firstQuiz = Course.GetQuizzes().FirstOrDefault();
                if (firstQuiz != null)
                {
                    navigate.NavigateTo($"/quizzes/{firstQuiz.Id}");
                }
            }
        }
    }

    private async Task SubmitReview()
    {
        if (userId == null || hasReviewed || isSubmittingReview)
            return;

        isSubmittingReview = true;
        StateHasChanged();

        try
        {
            var review = await data.AddReviewAsync(userId, Id, newReviewRating, newReviewComment);
            if (review != null)
            {
                hasReviewed = true;
                newReviewRating = 5;
                newReviewComment = string.Empty;

                Course = await data.GetCourseByIdAsync(Id);

                await JS.InvokeVoidAsync("showToast", "success", "Спасибо за ваш отзыв!");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("showToast", "error", "Ошибка при отправке отзыва: " + ex.Message);
        }
        finally
        {
            isSubmittingReview = false;
            StateHasChanged();
        }
    }

    private MarkupString MarkupContent(string content)
    {
        var html = System.Net.WebUtility.HtmlEncode(content)
            .Replace("\n\n", "</p><p>")
            .Replace("\n", "<br>");

        return new MarkupString($"<p>{html}</p>");
    }
}