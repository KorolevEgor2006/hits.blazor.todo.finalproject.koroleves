@page "/lessons/{Id:int}"
@rendermode InteractiveServer
@using TheFinalProject.Data.Models
@using TheFinalProject.Data.Interfaces
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject ICourseService data
@inject NavigationManager navigate
@inject AuthenticationStateProvider authProvider
@inject IJSRuntime JS

<PageTitle>@(Lesson?.Title ?? "Урок")</PageTitle>

@if (Lesson == null || Course == null)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>
}
else
{
    <div class="container-fluid">
        <div class="row">
            
            <div class="col-lg-3 col-md-4 d-none d-md-block">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ol"></i> @Course.Title
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            @foreach (var element in courseElements.OrderBy(e => e.OrderNumber))
                            {
                                @if (element is Lesson lessonElement)
                                {
                                    <a href="@($"/lessons/{lessonElement.Id}")"
                                       class="list-group-item list-group-item-action @(lessonElement.Id == Id ? "active" : "")">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-play-circle me-2"></i>
                                                <span>@lessonElement.OrderNumber. @lessonElement.Title</span>
                                            </div>
                                            @if (completedLessons?.Contains(lessonElement.Id) == true)
                                            {
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            }
                                        </div>
                                    </a>
                                }
                                else if (element is Quiz quizElement)
                                {
                                    <a href="@($"/quizzes/{quizElement.Id}")"
                                       class="list-group-item list-group-item-action">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-question-circle me-2"></i>
                                                <span>@quizElement.OrderNumber. Тест: @quizElement.Title</span>
                                            </div>
                                            @if (passedQuizzes?.Contains(quizElement.Id) == true)
                                            {
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            }
                                        </div>
                                    </a>
                                }
                            }
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-grid">
                            <button class="btn btn-outline-primary btn-sm" @onclick="BackToCourse">
                                <i class="bi bi-arrow-left"></i> Назад к курсу
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9 col-md-8">
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/courses">Курсы</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="@($"/courses/{Course.Id}")">@Course.Title</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            Урок @Lesson.OrderNumber
                        </li>
                    </ol>
                </nav>

                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="h4 mb-0">
                                    <i class="bi bi-play-circle text-primary me-2"></i>
                                    @Lesson.Title
                                </h2>
                                <small class="text-muted">Урок @Lesson.OrderNumber</small>
                            </div>
                            <div>
                                @if (isCompleted)
                                {
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>Завершен
                                    </span>
                                }
                                <span class="badge bg-info ms-2">
                                    <i class="bi bi-clock me-1"></i>~@Lesson.GetEstimatedDuration() ч.
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Lesson.VideoUrl))
                        {
                            <div class="ratio ratio-16x9 mb-4">
                                <iframe src="@GetEmbedUrl(Lesson.VideoUrl)"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        allowfullscreen
                                        frameborder="0"
                                        class="rounded"></iframe>
                            </div>
                        }

                        <div class="lesson-content mb-4">
                            @MarkupContent(Lesson.Content)
                        </div>

                        @if (Lesson.HasPresentation || Lesson.HasAdditionalMaterials)
                        {
                            <div class="card border-info mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-download"></i> Материалы для скачивания
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        @if (Lesson.HasPresentation)
                                        {
                                            <div class="col-md-6 mb-3">
                                                <div class="card h-100 border">
                                                    <div class="card-body text-center">
                                                        <i class="bi bi-file-earmark-slides text-primary" style="font-size: 3rem;"></i>
                                                        <h5 class="mt-3">Презентация</h5>
                                                        <a href="@Lesson.PresentationUrl"
                                                           class="btn btn-outline-primary mt-2"
                                                           target="_blank"
                                                           download>
                                                            <i class="bi bi-download me-2"></i>Скачать
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        }

                                        @if (Lesson.HasAdditionalMaterials)
                                        {
                                            <div class="col-md-6 mb-3">
                                                <div class="card h-100 border">
                                                    <div class="card-body text-center">
                                                        <i class="bi bi-folder text-success" style="font-size: 3rem;"></i>
                                                        <h5 class="mt-3">Дополнительные материалы</h5>
                                                        <a href="@Lesson.AdditionalMaterialsUrl"
                                                           class="btn btn-outline-success mt-2"
                                                           target="_blank"
                                                           download>
                                                            <i class="bi bi-download me-2"></i>Скачать
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="border-top pt-4 mt-4">
                            <div class="d-flex justify-content-between">
                                <div>
                                    @if (previousLesson != null)
                                    {
                                        <a href="@($"/lessons/{previousLesson.Id}")" class="btn btn-outline-primary">
                                            <i class="bi bi-chevron-left me-2"></i>Предыдущий урок
                                        </a>
                                    }
                                </div>

                                <div>
                                    @if (!isCompleted && isEnrolled)
                                    {
                                        <button class="btn btn-success me-2" @onclick="MarkAsCompleted" disabled="@markingComplete">
                                            @if (markingComplete)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2" role="status">Сохранение...</span>
                                                
                                                                        }
                                            else
                                            {
                                                <i class="bi bi-check-circle me-2">Отметить как завершенный</i>
                                                
                                                                        }
                                        </button>
                                    }

                                    @if (isInstructor)
                                    {
                                        <button class="btn btn-warning" @onclick="EditLesson">
                                            <i class="bi bi-pencil me-2"></i>Редактировать
                                        </button>
                                    }
                                </div>

                                <div>
                                    @if (nextLesson != null)
                                    {
                                        <a href="@($"/lessons/{nextLesson.Id}")" class="btn btn-primary">
                                            Следующий урок <i class="bi bi-chevron-right ms-2"></i>
                                        </a>
                                    }
                                    else if (nextQuiz != null)
                                    {
                                        <a href="@($"/quizzes/{nextQuiz.Id}")" class="btn btn-primary">
                                            Пройти тест <i class="bi bi-chevron-right ms-2"></i>
                                        </a>
                                    }
                                    else if (isEnrolled && !Course.GetQuizzes().Any())
                                    {
                                        <button class="btn btn-primary" @onclick="CompleteCourse">
                                            Завершить курс <i class="bi bi-award ms-2"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @if (Lesson.Quizzes.Any())
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-question-circle text-primary me-2"></i>
                                Тесты для этого урока
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                @foreach (var quiz in Lesson.Quizzes)
                                {
                                    var isQuizPassed = passedQuizzes?.Contains(quiz.Id) == true;
                                    var attemptsCount = enrollment?.GetQuizAttemptCount(quiz.Id) ?? 0;

                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100 border @(isQuizPassed ? "border-success" : "border-secondary")">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0">@quiz.Title</h6>
                                                    <span class="badge @(quiz.Difficulty.ToString() == "Easy" ? "bg-success" : quiz.Difficulty.ToString() == "Medium" ? "bg-warning" : "bg-danger")">
                                                        @GetDifficultyText(quiz.Difficulty)
                                                    </span>
                                                </div>
                                                <p class="card-text small text-muted">@quiz.Description</p>

                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <small class="text-muted">
                                                            <i class="bi bi-clock me-1"></i>@quiz.TimeLimitMinutes мин.
                                                        </small>
                                                        <small class="text-muted ms-3">
                                                            <i class="bi bi-trophy me-1"></i>@quiz.Points баллов
                                                        </small>
                                                    </div>

                                                    @if (isQuizPassed)
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle me-1"></i>Пройден
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn btn-sm @(attemptsCount > 0 ? "btn-outline-warning" : "btn-outline-primary")"
                                                                @onclick="() => StartQuiz(quiz.Id)">
                                                            @if (attemptsCount > 0)
                                                            {
                                                                <span>Попытка @attemptsCount</span>
                                                            }
                                                            else
                                                            {
                                                                <span>Начать тест</span>
                                                            }
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                @if (isEnrolled)
                {
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="alert-heading">
                                    <i class="bi bi-graph-up me-2"></i>Ваш прогресс
                                </h5>
                                <p class="mb-0">Общий прогресс по курсу: <strong>@courseProgress.ToString("F1")%</strong></p>
                            </div>
                            <div class="text-end">
                                <div class="progress" style="width: 200px; height: 20px;">
                                    <div class="progress-bar bg-info" role="progressbar"
                                         style="width: @courseProgress%"
                                         aria-valuenow="@courseProgress"
                                         aria-valuemin="0"
                                         aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Lesson? Lesson { get; set; }
    private Course? Course { get; set; }
    private List<CourseElement> courseElements = new();
    private List<int>? completedLessons;
    private List<int>? passedQuizzes;
    private bool isCompleted = false;
    private bool isEnrolled = false;
    private bool isInstructor = false;
    private double courseProgress = 0;
    private Lesson? previousLesson;
    private Lesson? nextLesson;
    private Quiz? nextQuiz;
    private string? userId;
    private Enrollment? enrollment;
    private bool markingComplete = false;

    protected override async Task OnInitializedAsync()
    {
        Lesson = await data.GetLessonByIdAsync(Id);

        if (Lesson?.CourseId != null)
        {
            Course = await data.GetCourseByIdAsync(Lesson.CourseId);
            if (Course == null)
            {
                navigate.NavigateTo("/courses");
                return;
            }

            var elements = await data.GetCourseElementsAsync(Course.Id);
            courseElements = elements.ToList();

            var authState = await authProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            isInstructor = user.IsInRole("Instructor") || user.IsInRole("Admin");

            if (userId != null)
            {
                isEnrolled = await data.IsUserEnrolledAsync(userId, Course.Id);
                if (isEnrolled)
                {
                    enrollment = await data.GetUserEnrollmentAsync(userId, Course.Id);
                    completedLessons = enrollment?.LessonProgresses
                        .Where(lp => lp.IsCompleted)
                        .Select(lp => lp.LessonId)
                        .ToList();

                    passedQuizzes = enrollment?.QuizAttempts
                        .Where(qa => qa.IsCorrect)
                        .Select(qa => qa.QuizId)
                        .Distinct()
                        .ToList();

                    isCompleted = completedLessons?.Contains(Id) == true;

                    courseProgress = await data.GetCourseProgressAsync(userId, Course.Id);
                }
            }

            // Find previous and next elements
            var lessons = courseElements.OfType<Lesson>().OrderBy(l => l.OrderNumber).ToList();
            var currentIndex = lessons.FindIndex(l => l.Id == Id);

            if (currentIndex > 0)
                previousLesson = lessons[currentIndex - 1];

            if (currentIndex < lessons.Count - 1)
                nextLesson = lessons[currentIndex + 1];
            else
            {
                // Check for quizzes after the last lesson
                var quizzes = courseElements.OfType<Quiz>()
                    .Where(q => q.OrderNumber > Lesson.OrderNumber)
                    .OrderBy(q => q.OrderNumber)
                    .FirstOrDefault();

                nextQuiz = quizzes;
            }
        }
    }

    private async Task MarkAsCompleted()
    {
        if (userId != null && !markingComplete)
        {
            markingComplete = true;
            StateHasChanged();

            await data.UpdateLessonProgressAsync(userId, Id, true);
            isCompleted = true;
            completedLessons?.Add(Id);

            courseProgress = await data.GetCourseProgressAsync(userId, Course!.Id);

            markingComplete = false;
            StateHasChanged();

            await JS.InvokeVoidAsync("showToast", "success", "Урок отмечен как завершенный!");
        }
    }

    private async Task CompleteCourse()
    {
        if (enrollment != null && userId != null)
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", "Вы уверены, что хотите завершить курс?");
            if (confirmed)
            {
                enrollment.CompleteCourse();
               
                await JS.InvokeVoidAsync("showToast", "success", "Курс успешно завершен!");
                navigate.NavigateTo($"/courses/{Course!.Id}");
            }
        }
    }

    private void StartQuiz(int quizId)
    {
        navigate.NavigateTo($"/quizzes/{quizId}");
    }

    private void EditLesson()
    {
        navigate.NavigateTo($"/lessons/edit/{Id}");
    }

    private void BackToCourse()
    {
        navigate.NavigateTo($"/courses/{Course!.Id}");
    }

    private string GetEmbedUrl(string videoUrl)
    {
        if (videoUrl.Contains("youtube.com") || videoUrl.Contains("youtu.be"))
        {
            var videoId = videoUrl.Contains("v=")
                ? videoUrl.Split("v=")[1].Split('&')[0]
                : videoUrl.Split('/').Last();
            return $"https://www.youtube.com/embed/{videoId}?rel=0";
        }
        else if (videoUrl.Contains("vimeo.com"))
        {
            var videoId = videoUrl.Split('/').Last();
            return $"https://player.vimeo.com/video/{videoId}";
        }
        return videoUrl;
    }

    private string GetDifficultyText(DifficultyLevel difficulty)
    {
        return difficulty switch
        {
            DifficultyLevel.Easy => "Легкий",
            DifficultyLevel.Medium => "Средний",
            DifficultyLevel.Hard => "Сложный",
            _ => "Неизвестно"
        };
    }

    private MarkupString MarkupContent(string content)
    {
        // Simple markdown-like parsing
        var html = System.Net.WebUtility.HtmlEncode(content)
            .Replace("\n\n", "</p><p>")
            .Replace("\n", "<br>")
            .Replace("### ", "<h3>").Replace("###", "</h3>")
            .Replace("## ", "<h2>").Replace("##", "</h2>")
            .Replace("# ", "<h1>").Replace("#", "</h1>")
            .Replace("**", "<strong>")
            .Replace("*", "<em>")
            .Replace("```", "<pre><code>")
            .Replace("`", "<code>");

        return new MarkupString($"<p>{html}</p>");
    }
}