@page "/my-courses"
@using TheFinalProject.Data.Models
@using TheFinalProject.Data.Interfaces
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Student,Instructor,Admin")]
@inject ICourseService data
@inject AuthenticationStateProvider authProvider
@inject NavigationManager navigate

<PageTitle>Мои курсы</PageTitle>

@if (loading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>
}
else
{
    <div class="container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1>
                    <i class="bi bi-journal-bookmark text-primary me-2"></i>Мои курсы
                </h1>
                <p class="text-muted">Здесь вы можете управлять всеми вашими курсами</p>
            </div>
            <div class="col-auto">
                <a href="/courses" class="btn btn-outline-primary">
                    <i class="bi bi-search me-2"></i>Найти новые курсы
                </a>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="card mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <button class="nav-link @(activeFilter == "all" ? "active" : "")"
                                @onclick="() => SetFilter(all)">
                            <i class="bi bi-grid me-2"></i>Все курсы (@allCourses.Count)
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link @(activeFilter == "active" ? "active" : "")"
                                @onclick="() => SetFilter(active)">
                            <i class="bi bi-play-circle me-2">Активные</i>(@activeCourses.Count)
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link @(activeFilter == "completed" ? "active" : "")"
                                @onclick="() => SetFilter(completed)">
                            <i class="bi bi-check-circle me-2"></i>Завершенные (@completedCourses.Count)
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link @(activeFilter == "inactive" ? "active" : "")"
                                @onclick="() => SetFilter(inactive)">
                            <i class="bi bi-pause-circle me-2"></i>Неактивные (@inactiveCourses.Count)
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Courses Grid -->
        @if (!displayedCourses.Any())
        {
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-journal-x text-muted" style="font-size: 4rem;"></i>
                    <h3 class="mt-4">@GetEmptyMessage()</h3>
                    <p class="text-muted">@GetEmptyDescription()</p>
                    @if (activeFilter != "all")
                    {
                        <button class="btn btn-primary mt-3" @onclick="() => SetFilter(all)">
                            <i class="bi bi-arrow-left me-2"></i>Посмотреть все курсы
                        </button>
                    }
                    else
                    {
                        <a href="/courses" class="btn btn-primary mt-3">
                            <i class="bi bi-search me-2"></i>Найти курсы
                        </a>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="row">
                @foreach (var course in displayedCourses)
                {
                    var enrollment = course.Enrollments.First(e => e.UserId == userId);
                    var progress = enrollment.ProgressPercentage;
                    var isCompleted = enrollment.IsCompleted;

                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card h-100 course-card @(isCompleted ? "border-success" : progress > 0 ? "border-primary" : "")">
                            @if (!string.IsNullOrEmpty(course.ImageUrl))
                            {
                                <img src="@course.ImageUrl" class="card-img-top" alt="@course.Title" style="height: 180px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 180px;">
                                    <i class="bi bi-journal-text text-white" style="font-size: 3rem;"></i>
                                </div>
                            }

                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">@course.Title</h5>
                                    @if (isCompleted)
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-award me-1"></i>Завершен
                                        </span>
                                    }
                                    else if (enrollment.Status == EnrollmentStatus.Dropped)
                                    {
                                        <span class="badge bg-danger">Брошен</span>
                                    }
                                    else if (enrollment.Status == EnrollmentStatus.Inactive)
                                    {
                                        <span class="badge bg-warning text-dark">Неактивен</span>
                                    }
                                </div>

                                <div class="mb-3">
                                    <span class="badge bg-info me-1">@course.Category</span>
                                    <span class="badge bg-secondary me-1">@course.Level</span>
                                    @if (course.Price == 0)
                                    {
                                        <span class="badge bg-success">Бесплатно</span>
                                    }
                                </div>

                                <p class="card-text flex-grow-1">
                                    @(course.ShortDescription?.Length > 100 ? course.ShortDescription.Substring(0, 100) + "..." : course.ShortDescription)
                                </p>

                                <div class="mt-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small>Прогресс:</small>
                                        <small>@progress.ToString("F1")%</small>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar @(isCompleted ? "bg-success" : "bg-primary")" role="progressbar"
                                             style="width: @progress%"
                                             aria-valuenow="@progress"
                                             aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-6">
                                        <small class="text-muted">
                                            <i class="bi bi-book me-1"></i>@course.LessonCount уроков
                                        </small>
                                    </div>
                                    <div class="col-6 text-end">
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>@course.ActualDurationHours ч.
                                        </small>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <small class="text-muted d-block">
                                        <i class="bi bi-person me-1"></i>@course.Instructor?.FullName
                                    </small>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>Записан: @enrollment.EnrollmentDate.ToString("dd.MM.yyyy")
                                    </small>
                                </div>
                            </div>

                            <div class="card-footer">
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    @if (!isCompleted && enrollment.Status == EnrollmentStatus.Active)
                                    {
                                        <a href="@($"/courses/{course.Id}")
                                           class="btn btn-primary btn-sm">
                                            <i class="bi bi-play-circle me-1"></i>Продолжить
                                        </a>
                                    }
                                    else if (isCompleted)
                                    {
                                        <button class="btn btn-success btn-sm" @onclick="() => ReviewCourse(course.Id)">
                                            <i class="bi bi-star me-1"></i>Оценить
                                        </button>
                                    }
                                    else if (enrollment.Status == EnrollmentStatus.Inactive)
                                    {
                                        <button class="btn btn-outline-warning btn-sm" @onclick="() => ResumeCourse(course.Id)">
                                            <i class="bi bi-play me-1"></i>Возобновить
                                        </button>
                                    }

                                    <a href="@($"/courses/{course.Id}")"
                                       class="btn btn-outline-info btn-sm ms-1">
                                        <i class="bi bi-info-circle"></i>
                                    </a>

                                    @if (!isCompleted)
                                    {
                                        <button class="btn btn-outline-danger btn-sm ms-1"
                                                @onclick="() => DropCourse(course.Id)">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- Statistics Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>Моя статистика обучения
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 mb-3">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h2 class="text-primary">@allCourses.Count</h2>
                                <small class="text-muted">Всего курсов</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-success">
                            <div class="card-body">
                                <h2 class="text-success">@completedCourses.Count</h2>
                                <small class="text-muted">Завершено</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h2 class="text-warning">@activeCourses.Count</h2>
                                <small class="text-muted">Активные</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-info">
                            <div class="card-body">
                                <h2 class="text-info">@averageProgress.ToString("F1")%</h2>
                                <small class="text-muted">Средний прогресс</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Course> allCourses = new();
    private List<Course> activeCourses = new();
    private List<Course> completedCourses = new();
    private List<Course> inactiveCourses = new();
    private List<Course> displayedCourses = new();
    private string activeFilter = "all";
    private bool loading = true;
    private string? userId;
    private double averageProgress = 0;
    private string all = "all";
    private string inactive = "inactive";
    private string active = "active";
    private string completed = "completed";

    protected override async Task OnInitializedAsync()
    {
        var authState = await authProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (userId != null)
        {
            allCourses = (await data.GetUserCoursesAsync(userId)).ToList();
            await CategorizeCourses();
            SetFilter("all");

            // Calculate average progress
            if (allCourses.Any())
            {
                var totalProgress = 0.0;
                foreach (var course in allCourses)
                {
                    var enrollment = course.Enrollments.First(e => e.UserId == userId);
                    totalProgress += enrollment.ProgressPercentage;
                }
                averageProgress = totalProgress / allCourses.Count;
            }
        }

        loading = false;
    }

    private async Task CategorizeCourses()
    {
        activeCourses.Clear();
        completedCourses.Clear();
        inactiveCourses.Clear();

        foreach (var course in allCourses)
        {
            var enrollment = course.Enrollments.First(e => e.UserId == userId);

            if (enrollment.IsCompleted)
            {
                completedCourses.Add(course);
            }
            else if (enrollment.Status == EnrollmentStatus.Active)
            {
                activeCourses.Add(course);
            }
            else
            {
                inactiveCourses.Add(course);
            }
        }
    }

    private void SetFilter(string filter)
    {
        activeFilter = filter;

        displayedCourses = filter switch
        {
            "active" => activeCourses,
            "completed" => completedCourses,
            "inactive" => inactiveCourses,
            _ => allCourses
        };

        StateHasChanged();
    }

    private string GetEmptyMessage()
    {
        return activeFilter switch
        {
            "active" => "Нет активных курсов",
            "completed" => "Нет завершенных курсов",
            "inactive" => "Нет неактивных курсов",
            _ => "У вас еще нет курсов"
        };
    }

    private string GetEmptyDescription()
    {
        return activeFilter switch
        {
            "active" => "Начните обучение, записавшись на интересующие вас курсы.",
            "completed" => "Завершенные курсы появятся здесь после прохождения.",
            "inactive" => "Неактивные курсы появятся здесь после приостановки обучения.",
            _ => "Найдите интересные курсы и начните обучение."
        };
    }

    private void ReviewCourse(int courseId)
    {
        navigate.NavigateTo($"/courses/{courseId}#reviews");
    }

    private async Task ResumeCourse(int courseId)
    {
        // TODO: Implement resume course functionality
        Console.WriteLine($"Resume course {courseId}");
    }

    private async Task DropCourse(int courseId)
    {
        // TODO: Implement drop course functionality
        Console.WriteLine($"Drop course {courseId}");
    }
}